{{define "content"}}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Modification de la Strat√©gie</h1>
                <a href="/strategies" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Retour
                </a>
            </div>

            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">√âdition de la strat√©gie</h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="/strategies/{{.strategy.ID}}/update">
                                <!-- Basic Strategy Info -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="name" class="form-label">Nom de la strat√©gie *</label>
                                        <input type="text" class="form-control" id="name" name="name" value="{{.strategy.Name}}" required 
                                               placeholder="ex: Scalping Agressif">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="algorithm" class="form-label">Algorithme *</label>
                                        <select class="form-select" id="algorithm" name="algorithm" required onchange="updateAlgorithmFields()">
                                            <option value="">S√©lectionner un algorithme</option>
                                            <option value="rsi_dca" {{if eq .strategy.AlgorithmName "rsi_dca"}}selected{{end}}>RSI DCA (Dollar Cost Averaging)</option>
                                            <option value="macd_cross" {{if eq .strategy.AlgorithmName "macd_cross"}}selected{{end}}>MACD Crossover</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Statut</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enabled" name="enabled" {{if .strategy.Enabled}}checked{{end}}>
                                            <label class="form-check-label" for="enabled">
                                                Strat√©gie activ√©e
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="2" 
                                              placeholder="Description de la strat√©gie...">{{.strategy.Description}}</textarea>
                                </div>

                                <!-- Scheduling & Basic Config -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="cron" class="form-label">Expression Cron *</label>
                                        <input type="text" class="form-control" id="cron" name="cron" value="{{.strategy.CronExpression}}" required 
                                               placeholder="0 */4 * * *" onchange="updateCronDescription()">
                                        <div class="form-text" id="cron-description">Format: minute heure jour mois jour-semaine</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="quote_amount" class="form-label">Montant par ordre (USDT) *</label>
                                        <input type="number" step="0.01" class="form-control" id="quote_amount" name="quote_amount" 
                                               value="{{.strategy.QuoteAmount}}" required placeholder="25.00">
                                        <div class="form-text">Montant investi par ordre</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="concurrent_orders" class="form-label">Cycles simultan√©s max *</label>
                                        <input type="number" step="1" class="form-control" id="concurrent_cycles" name="concurrent_cycles" 
                                               value="{{.strategy.MaxConcurrentCycles}}" required placeholder="1">
                                        <div class="form-text">Limite de cycles ouverts en m√™me temps</div>
                                    </div>
                                </div>

                                <!-- Profit & Risk Settings -->
                                <h6 class="text-secondary mb-3">üìà Param√®tres de Profit et Risque</h6>
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <label for="profit_target" class="form-label">Objectif profit (%) *</label>
                                        <input type="number" step="0.1" class="form-control" id="profit_target" name="profit_target" 
                                               value="{{.strategy.ProfitTarget}}" required placeholder="2.0">
                                        <div class="form-text">Profit vis√© par cycle</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="trailing_stop_delta" class="form-label">Trailing Stop (%)</label>
                                        <input type="number" step="0.01" class="form-control" id="trailing_stop_delta" name="trailing_stop_delta" 
                                               value="{{.strategy.TrailingStopDelta}}" placeholder="0.1">
                                        <div class="form-text">Protection contre les chutes</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="sell_offset" class="form-label">Offset vente (%)</label>
                                        <input type="number" step="0.01" class="form-control" id="sell_offset" name="sell_offset" 
                                               value="{{.strategy.SellOffset}}" placeholder="0.1">
                                        <div class="form-text">Marge de s√©curit√© pour la vente</div>
                                    </div>
                                </div>

                                <!-- Volatility Settings (Common to all algorithms) -->
                                <h6 class="text-secondary mb-3">üìä Param√®tres de Volatilit√©</h6>
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <label for="volatility_period" class="form-label">P√©riode volatilit√©</label>
                                        <input type="number" class="form-control" id="volatility_period" name="volatility_period" 
                                               {{if .strategy.VolatilityPeriod}}value="{{.strategy.VolatilityPeriod}}"{{else}}value="7"{{end}} placeholder="7">
                                        <div class="form-text">Nombre de bougies pour le calcul</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="volatility_adjustment" class="form-label">Ajustement volatilit√© (%)</label>
                                        <input type="number" step="0.1" class="form-control" id="volatility_adjustment" name="volatility_adjustment" 
                                               {{if .strategy.VolatilityAdjustment}}value="{{.strategy.VolatilityAdjustment}}"{{else}}value="50.0"{{end}} placeholder="50.0">
                                        <div class="form-text">Facteur d'ajustement bas√© sur la volatilit√©</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="volatility_timeframe" class="form-label">Timeframe volatilit√©</label>
                                        <select class="form-select" id="volatility_timeframe" name="volatility_timeframe">
                                            <option value="1m" {{if eq .strategy.VolatilityTimeframe "1m"}}selected{{end}}>1 minute</option>
                                            <option value="5m" {{if eq .strategy.VolatilityTimeframe "5m"}}selected{{end}}>5 minutes</option>
                                            <option value="15m" {{if eq .strategy.VolatilityTimeframe "15m"}}selected{{end}}>15 minutes</option>
                                            <option value="1h" {{if eq .strategy.VolatilityTimeframe "1h"}}selected{{end}}>1 heure</option>
                                            <option value="4h" {{if or (eq .strategy.VolatilityTimeframe "4h") (eq .strategy.VolatilityTimeframe "")}}selected{{end}}>4 heures</option>
                                            <option value="1d" {{if eq .strategy.VolatilityTimeframe "1d"}}selected{{end}}>1 jour</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- RSI Specific Fields -->
                                <div id="rsi-fields" style="display: none;">
                                    <h6 class="text-primary mb-3">üìà Param√®tres RSI</h6>
                                    <div class="row mb-4">
                                        <div class="col-md-4">
                                            <label for="rsi_threshold" class="form-label">Seuil RSI</label>
                                            <input type="number" step="0.1" class="form-control" id="rsi_threshold" name="rsi_threshold" 
                                                   {{if .strategy.RSIThreshold}}value="{{.strategy.RSIThreshold}}"{{end}} placeholder="30.0">
                                            <div class="form-text">RSI < seuil = signal d'achat</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="rsi_period" class="form-label">P√©riode RSI</label>
                                            <input type="number" class="form-control" id="rsi_period" name="rsi_period" 
                                                   {{if .strategy.RSIPeriod}}value="{{.strategy.RSIPeriod}}"{{else}}value="14"{{end}} placeholder="14">
                                            <div class="form-text">Nombre de bougies (14 = standard)</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="rsi_timeframe" class="form-label">Timeframe RSI</label>
                                            <select class="form-select" id="rsi_timeframe" name="rsi_timeframe">
                                                <option value="1m" {{if eq .strategy.RSITimeframe "1m"}}selected{{end}}>1 minute</option>
                                                <option value="5m" {{if eq .strategy.RSITimeframe "5m"}}selected{{end}}>5 minutes</option>
                                                <option value="15m" {{if eq .strategy.RSITimeframe "15m"}}selected{{end}}>15 minutes</option>
                                                <option value="1h" {{if eq .strategy.RSITimeframe "1h"}}selected{{end}}>1 heure</option>
                                                <option value="4h" {{if or (eq .strategy.RSITimeframe "4h") (eq .strategy.RSITimeframe "")}}selected{{end}}>4 heures</option>
                                                <option value="1d" {{if eq .strategy.RSITimeframe "1d"}}selected{{end}}>1 jour</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- MACD Specific Fields -->
                                <div id="macd-fields" style="display: none;">
                                    <h6 class="text-success mb-3">üìä Param√®tres MACD</h6>
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <label for="macd_fast_period" class="form-label">EMA Rapide</label>
                                            <input type="number" class="form-control" id="macd_fast_period" name="macd_fast_period" 
                                                   value="{{.strategy.MACDFastPeriod}}" placeholder="12">
                                            <div class="form-text">P√©riode EMA rapide</div>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="macd_slow_period" class="form-label">EMA Lente</label>
                                            <input type="number" class="form-control" id="macd_slow_period" name="macd_slow_period" 
                                                   value="{{.strategy.MACDSlowPeriod}}" placeholder="26">
                                            <div class="form-text">P√©riode EMA lente</div>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="macd_signal_period" class="form-label">Ligne de signal</label>
                                            <input type="number" class="form-control" id="macd_signal_period" name="macd_signal_period" 
                                                   value="{{.strategy.MACDSignalPeriod}}" placeholder="9">
                                            <div class="form-text">P√©riode ligne de signal</div>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="macd_timeframe" class="form-label">Timeframe MACD</label>
                                            <select class="form-select" id="macd_timeframe" name="macd_timeframe">
                                                <option value="1m" {{if eq .strategy.MACDTimeframe "1m"}}selected{{end}}>1 minute</option>
                                                <option value="5m" {{if eq .strategy.MACDTimeframe "5m"}}selected{{end}}>5 minutes</option>
                                                <option value="15m" {{if eq .strategy.MACDTimeframe "15m"}}selected{{end}}>15 minutes</option>
                                                <option value="1h" {{if eq .strategy.MACDTimeframe "1h"}}selected{{end}}>1 heure</option>
                                                <option value="4h" {{if or (eq .strategy.MACDTimeframe "4h") (eq .strategy.MACDTimeframe "")}}selected{{end}}>4 heures</option>
                                                <option value="1d" {{if eq .strategy.MACDTimeframe "1d"}}selected{{end}}>1 jour</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Bollinger Bands Fields (hidden by default, could be used by future algorithms) -->
                                <div id="bb-fields" style="display: none;">
                                    <h6 class="text-warning mb-3">üìä Param√®tres Bollinger Bands</h6>
                                    <div class="row mb-4">
                                        <div class="col-md-4">
                                            <label for="bb_period" class="form-label">P√©riode BB</label>
                                            <input type="number" class="form-control" id="bb_period" name="bb_period" 
                                                   value="{{.strategy.BBPeriod}}" placeholder="20">
                                            <div class="form-text">Nombre de p√©riodes pour la moyenne mobile</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="bb_multiplier" class="form-label">Multiplicateur BB</label>
                                            <input type="number" step="0.1" class="form-control" id="bb_multiplier" name="bb_multiplier" 
                                                   value="{{.strategy.BBMultiplier}}" placeholder="2.0">
                                            <div class="form-text">√âcart-type multipli√© par ce facteur</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="bb_timeframe" class="form-label">Timeframe BB</label>
                                            <select class="form-select" id="bb_timeframe" name="bb_timeframe">
                                                <option value="1m" {{if eq .strategy.BBTimeframe "1m"}}selected{{end}}>1 minute</option>
                                                <option value="5m" {{if eq .strategy.BBTimeframe "5m"}}selected{{end}}>5 minutes</option>
                                                <option value="15m" {{if eq .strategy.BBTimeframe "15m"}}selected{{end}}>15 minutes</option>
                                                <option value="1h" {{if or (eq .strategy.BBTimeframe "1h") (eq .strategy.BBTimeframe "")}}selected{{end}}>1 heure</option>
                                                <option value="4h" {{if eq .strategy.BBTimeframe "4h"}}selected{{end}}>4 heures</option>
                                                <option value="1d" {{if eq .strategy.BBTimeframe "1d"}}selected{{end}}>1 jour</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit -->
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                    <button type="button" class="btn btn-outline-secondary me-md-2" onclick="window.history.back()">Annuler</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Modifier la strat√©gie
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updateAlgorithmFields() {
    const algorithm = document.getElementById('algorithm').value;
    const rsiFields = document.getElementById('rsi-fields');
    const macdFields = document.getElementById('macd-fields');
    const bbFields = document.getElementById('bb-fields');
    
    // Hide all algorithm-specific fields
    rsiFields.style.display = 'none';
    macdFields.style.display = 'none';
    bbFields.style.display = 'none';
    
    // Show relevant fields based on selected algorithm
    if (algorithm === 'rsi_dca') {
        rsiFields.style.display = 'block';
    } else if (algorithm === 'macd_cross') {
        macdFields.style.display = 'block';
    }
    // BB fields could be shown for a future bollinger bands algorithm
}

function updateCronDescription() {
    const cron = document.getElementById('cron').value;
    const description = document.getElementById('cron-description');
    
    if (!cron.trim()) {
        description.textContent = 'Format: minute heure jour mois jour-semaine';
        description.className = 'form-text text-muted';
        return;
    }
    
    try {
        // Utiliser cronstrue pour traduire l'expression cron
        if (typeof cronstrue !== 'undefined') {
            const translatedCron = cronstrue.toString(cron, {
                locale: 'fr',
                throwExceptionOnParseError: true,
                verbose: false,
                dayOfWeekStartIndexZero: true
            });
            description.textContent = translatedCron;
            description.className = 'form-text text-success';
        } else {
            // Fallback si cronstrue n'est pas charg√©
            description.textContent = 'Expression cron valide';
            description.className = 'form-text text-success';
        }
    } catch (err) {
        // Expression cron invalide
        description.textContent = 'Expression cron invalide - Format: minute heure jour mois jour-semaine';
        description.className = 'form-text text-danger';
    }
}

// Initialize fields display on page load
document.addEventListener('DOMContentLoaded', function() {
    updateAlgorithmFields();
    updateCronDescription();
});
</script>
{{end}}